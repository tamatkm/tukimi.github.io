<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CoC 探索者カードメーカー（公開共有URL対応）</title>
<style>
  :root{--bg:#f6f7fb;--panel:#fff;--ink:#17181c;--muted:#6b7280;--line:#e6e7ee;--accent:#4f46e5;--accent-ink:#fff;--soft:#f3f4f6;--danger:#ef4444;--radius:16px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--ink);background:
    radial-gradient(1200px 500px at 100% -20%, #e8e9ff 0%, transparent 60%),
    radial-gradient(1200px 500px at -10% 120%, #e7fff7 0%, transparent 60%),var(--bg);
    font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Yu Gothic",Meiryo,sans-serif;letter-spacing:.2px}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:color-mix(in oklab,#fff 85%,transparent);border-bottom:1px solid var(--line)}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .search{flex:1 1 700px;min-width:420px;max-width:100%}
  @media (max-width:720px){ .search{flex:1 1 100%;min-width:0} }
  h1{font-size:22px;margin:0 14px 0 0;font-weight:700}
  input[type="text"],textarea,input[type="file"],input[type="color"],select{
    width:100%;border:1px solid var(--line);background:#fff;color:var(--ink);
    border-radius:10px;padding:10px 12px;outline:none
  }
  textarea{resize:vertical;min-height:120px}
  .btn{cursor:pointer;border:1px solid var(--line);background:var(--panel);color:var(--ink);padding:10px 14px;border-radius:999px;font-weight:600;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  .btn:hover{background:var(--soft)} .btn.primary{background:var(--accent);color:var(--accent-ink);border-color:transparent}
  .small{font-size:12px;color:var(--muted)}
  .grid{display:grid;gap:18px;grid-template-columns:repeat(1,minmax(0,1fr))}
  @media(min-width:640px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media(min-width:980px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .card{position:relative;background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.04)}
  .accent-bar{position:absolute;inset:0 0 auto 0;height:6px;background:transparent}
  .thumb{aspect-ratio:16/9;background:#eef0f5;position:relative;display:block}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block;pointer-events:none}
  .thumb.contain img{object-fit:contain;background:#eef0f5}
  .tools{position:absolute;display:flex;gap:6px;z-index:20;pointer-events:auto;background:color-mix(in oklab,#fff 85%,transparent);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:999px;padding:4px;box-shadow:0 6px 16px rgba(0,0,0,.12)}
  .pos-tr{top:8px;right:8px}.pos-br{bottom:8px;right:8px}.pos-tl{top:8px;left:8px}.pos-bl{bottom:8px;left:8px}
  .iconbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer}
  .iconbtn:hover{background:var(--soft)}
  .card .body{padding:14px}
  .title{font-size:18px;font-weight:800;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
  .title .dot{display:inline-block;width:.7em;height:.7em;border-radius:50%;vertical-align:baseline;margin-right:.35em;background:transparent;border:1px solid var(--line)}
  .meta{font-size:12px;color:var(--muted)}
  .statgrid{display:grid;gap:10px;margin-top:10px;grid-template-columns:repeat(auto-fill,minmax(92px,1fr))}
  .statbox{padding:6px 8px;background:var(--soft);border-radius:10px;font-size:13px;border:1px solid var(--line)}
  .statbox span{color:var(--muted);margin-right:6px}
  /* 共有モード用：丸アイコン一覧 */
  .sharewrap{max-width:1100px;margin:0 auto;padding:16px}
  .sharegrid{display:grid;gap:18px;grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
  .avatar{width:120px;height:120px;border-radius:999px;border:4px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.12);background:#eee;overflow:hidden;margin:0 auto}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .center{display:flex;gap:10px;align-items:center;justify-content:center;margin:16px 0;flex-wrap:wrap}
  .muted{color:#6b7280;font-size:12px}
  /* ダイアログ共通 */
  dialog{width:min(980px,92vw);border:1px solid var(--line);border-radius:18px;padding:0;box-shadow:0 30px 60px rgba(0,0,0,.18)}
  dialog::backdrop{background:rgba(0,0,0,.28)}
  .modal-head{padding:16px 20px;border-bottom:1px solid var(--line);font-weight:700;display:flex;align-items:center;gap:10px}
  .modal-body{padding:18px 20px}
  .modal-foot{padding:16px 20px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end}
  .cols{display:grid;gap:18px} @media(min-width:860px){.cols{grid-template-columns:280px 1fr}}
  .rows{display:grid;gap:10px}
  .preview{background:#eef0f5;border:1px solid var(--line);border-radius:14px;overflow:hidden;aspect-ratio:4/5;display:grid;place-items:center}
  .preview img{width:100%;height:100%;object-fit:cover}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <h1>CoC 探索者カードメーカー</h1>
    <input id="q" class="search" type="text" placeholder="名前・技能・メモで検索" />
    <label class="small"><input id="fitToggle" type="checkbox" checked /> サムネ収める</label>
    <label class="small"><input id="secretToggle" type="checkbox" checked /> 秘匿モード</label>

    <!-- ★ 共有設定（必ず表示される） -->
    <button class="btn" id="shareSettingBtn">共有設定</button>
    <!-- 共有URL（一覧）は共有設定のsrcで発行 -->
    <button class="btn" id="shareListBtn">共有URL（一覧）</button>
    <!-- 公開JSONを書き出し -->
    <button class="btn" id="exportShareBtn">共有データ書き出し(JSON)</button>

    <!-- 位置など既存 -->
    <label class="small">ボタン位置
      <select id="toolPosSel">
        <option value="br">右下（推奨）</option>
        <option value="tr">右上</option>
        <option value="tl">左上</option>
        <option value="bl">左下</option>
      </select>
    </label>

    <button class="btn" id="addBtn">探索者を作る</button>
    <button class="btn" id="exportBtn">JSONに書き出し</button>
    <label class="btn" for="importInput">JSON読込</label>
    <input id="importInput" class="invis" type="file" accept="application/json" />
  </div>
</header>

<main id="appMain" class="wrap">
  <section id="list" class="grid" aria-live="polite"></section>
  <div id="urlBox" class="small" style="margin-top:8px"></div>
</main>

<!-- 共有モードの一覧 -->
<main id="shareMain" class="sharewrap" style="display:none">
  <div class="center">
    <button class="btn" id="shareCopyThisPage">このページのURLをコピー</button>
    <span id="shareInfo" class="muted"></span>
  </div>
  <section id="shareGrid" class="sharegrid"></section>
  <div class="center">
    <button class="btn" id="sharePrev">← 前のページ</button>
    <button class="btn" id="shareNext">次のページ →</button>
    <span id="sharePagerText" class="muted"></span>
  </div>
</main>

<!-- 共有設定ダイアログ -->
<dialog id="shareDlg">
  <div class="modal-head">共有設定</div>
  <div class="modal-body">
    <div class="rows">
      <div>
        <label class="small">公開JSONのURL（src）</label>
        <input id="shareSrcInput" type="text" placeholder="/share/share_data.json または https://..." />
      </div>
      <div>
        <label class="small">1ページ人数（n）</label>
        <input id="shareNInput" type="number" min="1" max="200" value="20" />
      </div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn" id="shareCancel">閉じる</button>
    <button class="btn primary" id="shareSave">保存</button>
  </div>
</dialog>

<!-- 編集 -->
<dialog id="editDlg"><div class="modal-head">探索者の編集</div>
  <div class="modal-body">
    <div class="cols">
      <div class="rows">
        <div class="preview" id="editPreview"><span class="small">画像プレビュー</span></div>
        <label class="btn" for="imageInput">画像を選ぶ</label>
        <input id="imageInput" class="invis" type="file" accept="image/*" />
        <div><label class="small">名前</label><input id="name" type="text"/></div>
        <div class="rows">
          <label class="small">性別</label><input id="gender" type="text"/>
          <label class="small">一人称</label><input id="firstPerson" type="text"/>
          <label class="small">二人称</label><input id="secondPerson" type="text"/>
          <label class="small">口調</label><input id="speech" type="text"/>
        </div>
      </div>
      <div>
        <div class="row" style="gap:8px;margin-bottom:10px">
          <button class="btn" type="button" data-tab="stats">ステータス</button>
          <button class="btn" type="button" data-tab="skills">代表技能</button>
          <button class="btn" type="button" data-tab="notes">メモ</button>
          <span class="small">（クリックで切替）</span>
        </div>
        <section id="tabStats"><div id="statsGrid" class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px"></div></section>
        <section id="tabSkills" hidden><div id="skillsWrap" class="rows"></div><button class="btn" id="addSkillBtn" type="button">＋ 行を追加</button></section>
        <section id="tabNotes" hidden><textarea id="notes" rows="8" placeholder="背景・性格・RPメモなど"></textarea></section>
      </div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn" id="cancelEdit">キャンセル</button><button class="btn primary" id="saveEdit">保存</button></div>
</dialog>

<!-- プロフィール -->
<dialog id="viewDlg"><div class="modal-head"><span>探索者プロフィール</span><button class="btn" id="shareOneBtn">🔗 共有URL（この探索者）</button></div>
  <div class="modal-body">
    <div class="cols">
      <div class="rows">
        <div class="preview" id="viewPreview"></div>
        <div><div id="viewName" style="font-size:20px;font-weight:800"></div><div class="small" id="viewMeta"></div><div id="viewPronouns" style="margin-top:6px"></div></div>
      </div>
      <div>
        <div class="row" style="gap:8px;margin-bottom:10px">
          <button class="btn" type="button" data-vtab="v-profile">プロフィール</button>
          <button class="btn" type="button" data-vtab="v-stats">ステータス</button>
          <button class="btn" type="button" data-vtab="v-skills">技能</button>
        </div>
        <section id="vProfile"></section>
        <section id="vStats" hidden class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px"></section>
        <section id="vSkills" hidden class="rows"></section>
      </div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn" id="editFromView">編集</button><button class="btn primary" id="closeView">閉じる</button></div>
</dialog>

<script>
(() => {
  /* ===== version & base ===== */
  const VERSION = "share-config-1.0"; // ← 右上に「共有設定」が必ず出る版
  const PAGES_BASE = (() => {
    const { origin, pathname } = location;
    const base = pathname.replace(/\/index\.html$/, '').replace(/\/$/, '');
    return origin + base;
  })();
  const SHARE_CFG_KEY = "coc_share_cfg_v1"; // {src, n}

  /* ===== storage / idb ===== */
  const CURRENT_KEY="coc-investigators-html-v3";
  const DB_NAME="cocCardsDB", DB_VERSION=1, STORE="images";
  let dbPromise=null;
  function openDB(){ if(dbPromise) return dbPromise; dbPromise=new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VERSION); r.onupgradeneeded=()=>{const db=r.result;if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE)}; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);}); return dbPromise; }
  async function idbSet(key,blob){ const db=await openDB(); return new Promise((res,rej)=>{const tx=db.transaction(STORE,"readwrite"); tx.objectStore(STORE).put(blob,key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);});}
  async function idbGet(key){ const db=await openDB(); return new Promise((res,rej)=>{const tx=db.transaction(STORE,"readonly"); const rq=tx.objectStore(STORE).get(key); rq.onsuccess=()=>res(rq.result||null); rq.onerror=()=>rej(rq.error);});}

  /* ===== utils ===== */
  const $=s=>document.querySelector(s);
  const el=(t,p={},...k)=>{const n=document.createElement(t); for(const [k2,v] of Object.entries(p)){ if(k2==="class") n.className=v; else if(k2==="html") n.innerHTML=v; else if(k2.startsWith("on")&&typeof v==="function") n.addEventListener(k2.slice(2),v); else n.setAttribute(k2,v);} k.forEach(c=>n.append(c)); return n;};
  const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
  const escapeHtml=s=>(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","\"":"&quot;","'":"&#39;"}[m]));
  const DEFAULT_STATS=["STR","CON","POW","DEX","APP","SIZ","INT","EDU","HP","MP","SAN"].map(k=>({key:k,label:k}));
  const sample=()=>({id:uid(),name:"サンプル探索者",gender:"",firstPerson:"",secondPerson:"",speech:"",imageKey:"",color:"",notes:"",stats:DEFAULT_STATS.map(s=>({...s,value:"",secret:false})),skills:[],createdAt:Date.now(),updatedAt:Date.now()});

  /* ===== app state ===== */
  let list=[]; let viewing=null, editing=null; let fitContain=true, secretMode=true;
  let readOnly=false, isViewOpen=false, currentVTab="v-profile";

  function showURL(u){ const box=$("#urlBox"); box.textContent=u; navigator.clipboard?.writeText(u).catch(()=>{}); }

  /* ===== share config ===== */
  function loadShareCfg(){ try{const c=JSON.parse(localStorage.getItem(SHARE_CFG_KEY)||"{}"); return {src:c.src||"", n:parseInt(c.n||"20",10)||20}; }catch{return {src:"",n:20};} }
  function saveShareCfg(cfg){ localStorage.setItem(SHARE_CFG_KEY, JSON.stringify(cfg)); }
  $("#shareSettingBtn").addEventListener("click", ()=>{
    const cfg=loadShareCfg(); $("#shareSrcInput").value=cfg.src; $("#shareNInput").value=cfg.n; $("#shareDlg").showModal();
  });
  $("#shareSave").addEventListener("click", ()=>{ saveShareCfg({src:$("#shareSrcInput").value.trim(), n:parseInt($("#shareNInput").value||"20",10)||20}); $("#shareDlg").close(); });
  $("#shareCancel").addEventListener("click", ()=> $("#shareDlg").close());

  /* ===== data load/save ===== */
  function loadLocal(){ try{const raw=localStorage.getItem(CURRENT_KEY); list=raw?JSON.parse(raw):[sample()];}catch{list=[sample()];} }
  function saveLocal(){ localStorage.setItem(CURRENT_KEY, JSON.stringify(list)); }

  /* ===== list render (normal) ===== */
  const listBox=$("#list");
  const toolSel=$("#toolPosSel");
  const TOOL_POS_KEY="coc_cards_toolpos_v1";
  function getToolPos(){ return localStorage.getItem(TOOL_POS_KEY) || "br"; }
  function setToolPos(v){ localStorage.setItem(TOOL_POS_KEY, v); }
  function toolsPosClass(v){ return v==="tr"?"pos-tr":v==="tl"?"pos-tl":v==="bl"?"pos-bl":"pos-br"; }
  const iconBtn=(txt,title,onClick)=>{ const b=el("button",{class:"iconbtn",title,type:"button","aria-label":title}); b.textContent=txt; b.addEventListener("click",onClick); return b; };

  async function renderList(){
    $("#appMain").style.display=""; $("#shareMain").style.display="none";
    listBox.innerHTML="";
    const q=$("#q").value.trim().toLowerCase();
    const filtered = !q? list : list.filter(v=>{
      const blob=[v.name,v.gender,v.firstPerson,v.secondPerson,v.speech,v.notes,...(v.skills||[]).map(s=>`${s.name}:${s.value}`)].filter(Boolean).join("\n").toLowerCase();
      return blob.includes(q);
    });
    if(!filtered.length){ listBox.append(el("div",{class:"small",html:"該当する探索者がいません。"})); return; }
    for(const item of filtered){
      const card=el("article",{class:"card"});
      const bar=el("div",{class:"accent-bar"}); if(item.color) bar.style.background=item.color; card.append(bar);
      const th=el("div",{class:"thumb"}); if(fitContain) th.classList.add("contain");
      th.addEventListener("click",(ev)=>{ if(ev.target.closest(".tools")) return; openView(item.id); });
      const img=el("img",{alt:item.name||"preview"});
      if(item.imageKey){ const b=await idbGet(item.imageKey); if(b) img.src=URL.createObjectURL(b); }
      th.append(item.imageKey? img : el("div",{class:"small",html:"画像なし"}));
      const tools=el("div",{class:`tools ${toolsPosClass(getToolPos())}`});
      tools.append(iconBtn("👁","プロフィール",(e)=>{e.preventDefault();e.stopPropagation();openView(item.id)}));
      // この探索者の公開URL（共有設定のsrcを使う）
      tools.append(iconBtn("🔗","この探索者の公開URL",(e)=>{ e.preventDefault(); e.stopPropagation();
        const cfg=loadShareCfg(); if(!cfg.src){ alert("共有設定のsrcが未設定です。『共有設定』から保存してください。"); return; }
        showURL(`${PAGES_BASE}/#/s/view/${encodeURIComponent(item.id)}?src=${encodeURIComponent(cfg.src)}`);
      }));
      tools.append(iconBtn("✏️","編集",(e)=>{e.preventDefault();e.stopPropagation();openEdit(item.id)}));
      th.append(tools);
      const body=el("div",{class:"body"});
      const title=el("div",{class:"title"}), dot=el("span",{class:"dot"}); if(item.color){ dot.style.background=item.color; title.style.color=item.color; }
      title.append(dot, document.createTextNode(item.name||"(無名の探索者)")); body.append(title);
      body.append(el("div",{class:"meta",html:[item.gender,item.firstPerson&&`一人称:${item.firstPerson}`,item.secondPerson&&`二人称:${item.secondPerson}`].filter(Boolean).join(" ・ ")}));
      card.append(th,body); listBox.append(card);
    }
    // 共有URL（一覧）…共有設定を使って発行
    $("#shareListBtn").onclick = ()=>{
      const cfg=loadShareCfg(); if(!cfg.src){ alert("共有設定のsrcが未設定です。『共有設定』から保存してください。"); return; }
      showURL(`${PAGES_BASE}/#/s/list?p=1&n=${cfg.n}&src=${encodeURIComponent(cfg.src)}`);
    };
  }

  /* ===== edit ===== */
  const eDlg=$("#editDlg");
  const statsGrid=$("#statsGrid"), skillsWrap=$("#skillsWrap");
  const input={ image:$("#imageInput"), preview:$("#editPreview"), name:$("#name"), gender:$("#gender"), first:$("#firstPerson"), second:$("#secondPerson"), speech:$("#speech"), notes:$("#notes") };
  document.querySelectorAll('[data-tab]').forEach(btn=>btn.addEventListener('click',()=>showTab(btn.dataset.tab)));
  function showTab(name){ $('#tabStats').hidden=name!=='stats'; $('#tabSkills').hidden=name!=='skills'; $('#tabNotes').hidden=name!=='notes'; }
  async function openEdit(id){ editing = id ? structuredClone(list.find(v=>v.id===id)) : sample(); await fillEditForm(); showTab("stats"); eDlg.showModal(); }
  async function fillEditForm(){
    if(editing.imageKey){ const b=await idbGet(editing.imageKey); if(b){ input.preview.innerHTML=`<img alt="preview" src="${URL.createObjectURL(b)}">`; } else input.preview.innerHTML=`<span class="small">画像なし</span>`; }
    else input.preview.innerHTML=`<span class="small">画像プレビュー</span>`;
    input.name.value=editing.name||""; input.gender.value=editing.gender||""; input.first.value=editing.firstPerson||""; input.second.value=editing.secondPerson||""; input.speech.value=editing.speech||""; input.notes.value=editing.notes||"";
    statsGrid.innerHTML=""; (editing.stats||DEFAULT_STATS.map(s=>({...s,value:"",secret:false}))).forEach((st,i)=>{ const row=el("div",{class:"grid",style:"grid-template-columns:52px 1fr auto;gap:8px"});
      row.append(el("div",{class:"small",html:st.label}),
        (()=>{ const v=el("input",{type:"text",value:st.value||"",placeholder:"数値"}); v.addEventListener("input",()=>editing.stats[i].value=v.value); return v; })(),
        (()=>{
          const lab=el("label",{class:"small",html:`<input type="checkbox" ${st.secret?"checked":""}> 秘匿`});
          lab.querySelector("input").addEventListener("change",(e)=>editing.stats[i].secret=e.target.checked); return lab; })());
      statsGrid.append(row);
    });
    rebuildSkills();
  }
  function rebuildSkills(){ skillsWrap.innerHTML=""; (editing.skills||[]).forEach((sk,idx)=>{ const row=el("div",{class:"grid",style:"grid-template-columns:1fr 120px 34px;gap:8px"});
    const n=el("input",{type:"text",value:sk.name||"",placeholder:"技能名"}); const v=el("input",{type:"text",value:sk.value||"",placeholder:"値"});
    const del=el("button",{class:"btn",type:"button",onClick:()=>{editing.skills.splice(idx,1);rebuildSkills();}},"✕");
    n.addEventListener("input",()=>editing.skills[idx].name=n.value); v.addEventListener("input",()=>editing.skills[idx].value=v.value);
    row.append(n,v,del); skillsWrap.append(row);
  });}
  $("#addSkillBtn").addEventListener("click",()=>{ editing.skills=[...(editing.skills||[]),{name:"",value:""}]; rebuildSkills(); });
  $("#imageInput").addEventListener("change", async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const key="img:"+(editing?.id || uid()); await idbSet(key,f); if(!editing.id) editing.id=key.slice(4); editing.imageKey=key; await fillEditForm(); });
  $("#saveEdit").addEventListener("click", async ()=>{ const now=Date.now(); Object.assign(editing,{ name:input.name.value.trim(), gender:input.gender.value.trim(), firstPerson:input.first.value.trim(), secondPerson:input.second.value.trim(), speech:input.speech.value.trim(), notes:input.notes.value, updatedAt:now }); const exists=list.some(v=>v.id===editing.id); list=exists? list.map(v=>v.id===editing.id?editing:v):[editing,...list]; saveLocal(); await renderList(); eDlg.close(); });
  $("#cancelEdit").addEventListener("click",()=>eDlg.close());

  /* ===== view ===== */
  const vDlg=$("#viewDlg");
  async function openView(id){
    viewing=structuredClone(list.find(v=>v.id===id)); if(!viewing) return;
    const vp=$("#viewPreview"); vp.classList.toggle("contain",fitContain);
    if(viewing.imageKey){ const b=await idbGet(viewing.imageKey); vp.innerHTML=b?`<img alt="${viewing.name}" src="${URL.createObjectURL(b)}">`:`<div class="small">画像なし</div>`; }
    else vp.innerHTML=`<div class="small">画像なし</div>`;
    $("#viewName").textContent=viewing.name||"(無名)"; $("#viewMeta").textContent=[viewing.gender,viewing.speech].filter(Boolean).join(" ・ ");
    $("#viewPronouns").innerHTML=[viewing.firstPerson&&`<span class="small">一人称 ${escapeHtml(viewing.firstPerson)}</span>`,viewing.secondPerson&&`<span class="small">二人称 ${escapeHtml(viewing.secondPerson)}</span>`].filter(Boolean).join(" ");
    currentVTab="v-profile"; renderVProfile(); clearVStats(); clearVSkills(); showVTab(currentVTab); vDlg.showModal();
    // この探索者の公開URL
    $("#shareOneBtn").onclick=()=>{ const cfg=loadShareCfg(); if(!cfg.src){ alert("共有設定のsrcが未設定です。『共有設定』から保存してください。"); return; } showURL(`${PAGES_BASE}/#/s/view/${encodeURIComponent(viewing.id)}?src=${encodeURIComponent(cfg.src)}`); };
  }
  function renderVProfile(){ $("#vProfile").textContent=(viewing?.notes||"（メモはありません）"); }
  function clearVStats(){ $("#vStats").innerHTML=""; } function clearVSkills(){ $("#vSkills").innerHTML=""; }
  function renderVStats(){ const b=$("#vStats"); b.innerHTML=""; (viewing?.stats||[]).forEach(st=>{ const row=el("div",{class:"grid",style:"grid-template-columns:52px 1fr auto;gap:8px"}); row.innerHTML=`<div class="small">${st.label}${st.secret?"（秘）":""}</div><div style="font-weight:800">${st.secret && secretMode?"秘":(st.value||"-")}</div><div></div>`; b.append(row); }); }
  function renderVSkills(){ const box=$("#vSkills"); box.innerHTML=""; const skills=(viewing?.skills||[]).filter(s=>s.name); if(!skills.length){ box.append(el("div",{class:"small",html:"代表技能は登録されていません。"})); return; } const g=el("div",{style:"display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(200px,1fr))"}); skills.forEach(s=>{ const row=el("div",{class:"grid",style:"grid-template-columns:52px 1fr auto;gap:8px"}); row.innerHTML=`<div class="small">技能</div><div><strong>${escapeHtml(s.name)}</strong></div><div class="small">${escapeHtml(s.value||"")}</div>`; g.append(row); }); box.append(g); }
  document.querySelectorAll('[data-vtab]').forEach(btn=>btn.addEventListener("click",()=>{ const n=btn.dataset.vtab; if(n==="v-profile"){ renderVProfile(); clearVStats(); clearVSkills(); } if(n==="v-stats"){ clearVSkills(); $("#vProfile").textContent=""; renderVStats(); } if(n==="v-skills"){ clearVStats(); $("#vProfile").textContent=""; renderVSkills(); } showVTab(n); }));
  function showVTab(n){ $("#vProfile").hidden=n!=="v-profile"; $("#vStats").hidden=n!=="v-stats"; $("#vSkills").hidden=n!=="v-skills"; }
  $("#closeView").addEventListener("click", ()=> vDlg.close());

  /* ===== share data export ===== */
  async function buildShareJSON(){ const people=[]; for(const it of list){ let img=""; if(it.imageKey){ const b=await idbGet(it.imageKey); if(b){ const r=new FileReader(); await new Promise((res,rej)=>{r.onload=()=>{img=r.result;res();}; r.onerror=rej; r.readAsDataURL(b);}); } } people.push({id:it.id,name:it.name,color:it.color||"",notes:it.notes||"",stats:(it.stats||[]).map(s=>({label:s.label,value:s.value,secret:!!s.secret})),skills:(it.skills||[]).map(s=>({name:s.name||"",value:s.value||""})),imageData:img}); } return { updatedAt:Date.now(), people }; }
  $("#exportShareBtn").addEventListener("click", async ()=>{ const data=await buildShareJSON(); const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="share_data.json"; a.click(); URL.revokeObjectURL(url); });

  /* ===== share mode (read only) ===== */
  let shareData=null;
  const shareMain=$("#shareMain"), shareGrid=$("#shareGrid"), shareInfo=$("#shareInfo"), sharePrev=$("#sharePrev"), shareNext=$("#shareNext"), sharePagerText=$("#sharePagerText");
  async function fetchShareData(src){ const abs=src.match(/^https?:\/\//)?src:(src.startsWith("/")?src:PAGES_BASE.replace(/\/$/,"/")+src); const r=await fetch(abs,{cache:"no-store"}); if(!r.ok) throw new Error("共有データ取得失敗"); return await r.json(); }
  function renderShareList({src,p,n}){ $("#appMain").style.display="none"; shareMain.style.display=""; shareGrid.innerHTML=""; const tot=shareData.people.length, pages=Math.max(1,Math.ceil(tot/n)); const page=Math.min(Math.max(1,p),pages); const sl=shareData.people.slice((page-1)*n,Math.min(page*n,tot)); sl.forEach(per=>{ const a=el("a",{class:"card",href:`${PAGES_BASE}/#/s/view/${encodeURIComponent(per.id)}?src=${encodeURIComponent(src)}`,style:"display:block;text-decoration:none;color:inherit;padding:14px;text-align:center"}); const av=el("div",{class:"avatar"}); if(per.imageData) av.append(el("img",{src:per.imageData,alt:per.name})); else av.append(el("div",{class:"small",html:"画像なし"})); const nm=el("div",{style:"margin-top:10px;font-weight:700"},per.name); a.append(av,nm); shareGrid.append(a); }); shareInfo.textContent=`全${tot}件 / 1ページ${n}件表示`; sharePagerText.textContent=`${page} / ${pages} ページ`; sharePrev.disabled=(page<=1); shareNext.disabled=(page>=pages); sharePrev.onclick=()=>{ location.hash=`#/s/list?p=${page-1}&n=${n}&src=${encodeURIComponent(src)}`; }; shareNext.onclick=()=>{ location.hash=`#/s/list?p=${page+1}&n=${n}&src=${encodeURIComponent(src)}`; }; $("#shareCopyThisPage").onclick=()=> showURL(`${PAGES_BASE}/#/s/list?p=${page}&n=${n}&src=${encodeURIComponent(src)}`); }
  async function renderShareView({src,id}){ const p=shareData.people.find(x=>x.id===id); if(!p){ alert("該当探索者が見つかりません"); location.hash=`#/s/list?src=${encodeURIComponent(src)}`; return; } $("#appMain").style.display="none"; shareMain.style.display="none"; const vp=$("#viewPreview"); if(p.imageData) vp.innerHTML=`<img alt="${p.name}" src="${p.imageData}">`; else vp.innerHTML=`<div class="small">画像なし</div>`; $("#viewName").textContent=p.name||"(無名)"; $("#viewMeta").textContent=""; $("#viewPronouns").innerHTML=""; currentVTab="v-profile"; $("#vProfile").textContent=(p.notes||"（メモはありません）"); $("#vStats").innerHTML=""; (p.stats||[]).forEach(st=>{ const row=el("div",{class:"grid",style:"grid-template-columns:52px 1fr auto;gap:8px"}); row.innerHTML=`<div class="small">${st.label||""}</div><div style="font-weight:800">${st.value||"-"}</div><div></div>`; $("#vStats").append(row); }); $("#vSkills").innerHTML=""; const skl=(p.skills||[]).filter(s=>s.name); if(!skl.length) $("#vSkills").append(el("div",{class:"small",html:"代表技能は登録されていません。"})); else{ const g=el("div",{style:"display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(200px,1fr))"}); skl.forEach(s=>{ const row=el("div",{class:"grid",style:"grid-template-columns:52px 1fr auto;gap:8px"}); row.innerHTML=`<div class="small">技能</div><div><strong>${escapeHtml(s.name)}</strong></div><div class="small">${escapeHtml(s.value||"")}</div>`; g.append(row); }); $("#vSkills").append(g); } $("#editFromView").style.display="none"; showVTab("v-profile"); $("#viewDlg").showModal(); $("#shareOneBtn").onclick=()=> showURL(`${PAGES_BASE}/#/s/view/${encodeURIComponent(p.id)}?src=${encodeURIComponent(src)}`); }

  /* ===== routing ===== */
  function parseHash(){ const h=location.hash||""; const [r,q]=h.split("?"); const params=new URLSearchParams(q||""); return {r,params};}
  async function handleRoute(){
    const {r,params}=parseHash();
    if(r?.startsWith("#/s/")){ // share mode
      const src=params.get("src"); if(!src){ alert("src=（共有JSONのURL）が必要です"); location.hash=""; return; }
      if(!shareData || shareData._src!==src){ try{ shareData=await fetchShareData(src); shareData._src=src; }catch(e){ console.error(e); alert("共有データの取得に失敗しました"); location.hash=""; return; } }
      if(r.startsWith("#/s/list")){ const p=parseInt(params.get("p")||"1",10); const n=parseInt(params.get("n")||"20",10); renderShareList({src,p,n}); return; }
      const m=r.match(/^#\/s\/view\/(.+)$/); if(m){ await renderShareView({src,id:decodeURIComponent(m[1])}); return; }
      location.hash=`#/s/list?src=${encodeURIComponent(src)}`; return;
    }
    // normal
    await renderList();
  }
  window.addEventListener("hashchange", handleRoute);

  /* ===== start ===== */
  (async()=>{ loadLocal(); toolSel.value=(localStorage.getItem(TOOL_POS_KEY)||"br"); toolSel.addEventListener("change", ()=>{ setToolPos(toolSel.value); renderList();}); $("#fitToggle").addEventListener("change",(e)=>{fitContain=e.target.checked; renderList();}); $("#secretToggle").addEventListener("change",(e)=>{secretMode=e.target.checked; renderList();}); $("#addBtn").addEventListener("click",()=>openEdit(null)); $("#exportBtn").addEventListener("click",()=>{ const blob=new Blob([JSON.stringify(list,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="investigators.json"; a.click(); URL.revokeObjectURL(url);}); $("#importInput").addEventListener("change",(ev)=>{ const f=ev.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); if(Array.isArray(data)){ list=data; saveLocal(); renderList(); } else alert("JSON形式が正しくありません。"); }catch{ alert("JSONの読み込みに失敗しました。"); } }; r.readAsText(f); ev.target.value=""; }); $("#shareListBtn").onclick=()=>{ const cfg=loadShareCfg(); if(!cfg.src){ alert("共有設定のsrcが未設定です。『共有設定』から保存してください。"); return; } showURL(`${PAGES_BASE}/#/s/list?p=1&n=${cfg.n}&src=${encodeURIComponent(cfg.src)}`); }; $("#exportShareBtn").onclick=async()=>{ const people=[]; for(const it of list){ let img=""; if(it.imageKey){ const b=await idbGet(it.imageKey); if(b){ const rd=new FileReader(); await new Promise((res,rej)=>{ rd.onload=()=>{img=rd.result;res();}; rd.onerror=rej; rd.readAsDataURL(b); }); } } people.push({id:it.id,name:it.name,color:it.color||"",notes:it.notes||"",stats:(it.stats||[]).map(s=>({label:s.label,value:s.value,secret:!!s.secret})),skills:(it.skills||[]).map(s=>({name:s.name||"",value:s.value||""})),imageData:img}); } const data={updatedAt:Date.now(),people}; const bl=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); const u=URL.createObjectURL(bl); const a=document.createElement("a"); a.href=u; a.download="share_data.json"; a.click(); URL.revokeObjectURL(u); }; await handleRoute(); })();

  // 右上に現在のバージョンを軽く出す（キャッシュ確認用）
  console.log("[CoC Cards]", VERSION, PAGES_BASE);
})();
</script>
</body>
</html>
